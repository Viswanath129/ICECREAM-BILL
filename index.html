<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VISWANATH AGENCIES - Wholesale Orders</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Libraries -->
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand-primary': '#2563EB', /* Deep Royal Blue */
                        'brand-dark': '#1E3A8A',
                        'brand-light': '#DBEAFE',
                        'accent-green': '#10B981',
                        'accent-red': '#EF4444',
                        'surface-bg': '#F1F5F9', /* Slate-100 */
                        'surface-card': '#FFFFFF',
                        'text-main': '#1E293B', /* Slate-800 */
                        'text-sub': '#64748B',   /* Slate-500 */
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'float': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.2s ease-out',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 },
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-font-smoothing: antialiased;
            background-color: #F1F5F9;
        }

        /* Optimized Number Inputs - Hide Spinners */
        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type='number'] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        /* Tab Styles */
        .tab-btn { position: relative; }
        .tab-active {
            color: #2563EB;
            font-weight: 700;
            background-color: #EFF6FF;
        }
        .tab-active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 3px;
            background-color: #2563EB;
            border-radius: 3px 3px 0 0;
        }
        .tab-inactive {
            color: #64748B;
            font-weight: 500;
        }
        .tab-inactive:hover {
            color: #1E293B;
            background-color: #F8FAFC;
        }

        /* Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Smooth Row Transition */
        .item-row { 
            contain: content; 
            transition: background-color 0.15s;
        }
        .item-row:active { background-color: #F1F5F9; }

        .d-none { display: none !important; }

        /* FIX: Mobile UX Problem 
           Target only text-based inputs to prevent iOS zoom, 
           avoiding global breakage for checkboxes/radios 
        */
        @media screen and (max-width: 768px) {
            input[type="text"],
            input[type="number"],
            input[type="tel"],
            input[type="email"] {
                font-size: 16px !important;
            }
        }
    </style>
</head>

<body class="text-text-main pb-40"> <!-- Increased padding for footer safety -->

    <!-- MAIN CONTAINER - Widened to max-w-7xl and added responsive padding -->
    <div class="max-w-7xl mx-auto relative px-4 md:px-6">

        <!-- 1. PROFESSIONAL HEADER -->
        <header class="bg-brand-primary text-white pt-6 pb-12 rounded-b-[2.5rem] shadow-lg relative z-0 -mx-4 md:-mx-6 px-6 mb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <p class="text-blue-200 text-xs font-bold tracking-widest uppercase mb-1">Wholesale Management</p>
                    <h1 class="text-2xl font-extrabold tracking-tight flex items-center">
                        <i class="fas fa-truck-fast mr-3 opacity-90"></i> VISWANATH
                    </h1>
                </div>
                <button id="headerShareBtn" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-sm transition active:scale-90 border border-white/10" aria-label="Share App">
                    <i class="fas fa-share-nodes text-white"></i>
                </button>
            </div>
        </header>

        <!-- FLOATING STATS CARD -->
        <div class="-mt-14 relative z-10 mb-6">
            <div class="bg-white rounded-2xl shadow-float p-1 grid grid-cols-3 divide-x divide-slate-100">
                <!-- Cases -->
                <div class="py-3 px-2 text-center">
                    <span class="block text-[10px] uppercase font-bold text-text-sub tracking-wider mb-1">Cases</span>
                    <span id="header-total-cases" class="block text-xl font-black text-text-main">0</span>
                </div>
                <!-- Value -->
                <div class="py-3 px-2 text-center">
                    <span class="block text-[10px] uppercase font-bold text-text-sub tracking-wider mb-1">Total Value</span>
                    <span id="header-total-value" class="block text-xl font-black text-brand-primary">₹0</span>
                </div>
                <!-- Volume -->
                <div class="py-3 px-2 text-center">
                    <span class="block text-[10px] uppercase font-bold text-text-sub tracking-wider mb-1">Vol (L)</span>
                    <span id="header-total-liters" class="block text-xl font-black text-text-main">0</span>
                </div>
            </div>
        </div>

        <!-- 2. MAIN CONTENT -->
        <main>
            
            <!-- TABS -->
            <!-- FIX: Accessibility - Added aria labels and roles -->
            <div class="bg-white rounded-xl shadow-sm p-1.5 mb-5 flex" role="tablist">
                <button class="tab-btn flex-1 py-3 rounded-lg text-sm transition-all duration-200 tab-active" role="tab" aria-selected="true" data-target="items-tab" id="tab-products">
                    <i class="fas fa-box-open mr-2"></i> Products
                </button>
                <button class="tab-btn flex-1 py-3 rounded-lg text-sm transition-all duration-200 tab-inactive" role="tab" aria-selected="false" data-target="bill-tab" id="tab-bill">
                    <i class="fas fa-receipt mr-2"></i> Order Bill 
                    <span id="bill-badge" class="ml-1 px-2 py-0.5 bg-accent-red text-white text-[10px] font-bold rounded-full hidden">0</span>
                </button>
            </div>

            <!-- ==================== ITEMS TAB ==================== -->
            <section id="items-tab" class="tab-content block animate-fade-in" role="tabpanel" aria-labelledby="tab-products">
                
                <!-- Search -->
                <div class="relative mb-4">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-400"></i>
                    </div>
                    <input type="text" id="searchInput" 
                        class="block w-full pl-11 pr-10 py-3.5 bg-white border-none rounded-xl text-base font-medium text-text-main shadow-sm focus:ring-2 focus:ring-brand-primary/20 placeholder-slate-400" 
                        placeholder="Search items..." aria-label="Search products">
                    <button id="clearSearchBtn" class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-slate-600 hidden" aria-label="Clear search">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>

                <!-- Categories - Updated with Flex Wrap on Desktop -->
                <div class="mb-5">
                    <div id="category-chips" class="flex gap-2 overflow-x-auto md:overflow-visible md:flex-wrap no-scrollbar pb-2" role="group" aria-label="Product Categories">
                        <!-- JS Injected -->
                    </div>
                </div>

                <!-- Product List - Updated to table-auto -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-100">
                    <table class="w-full text-left table-auto">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="pl-4 pr-2 py-3 text-xs font-bold text-text-sub uppercase tracking-wider">Item Details</th>
                                <th class="px-1 py-3 text-center text-xs font-bold text-text-sub uppercase tracking-wider w-[70px]">MRP</th>
                                <th class="pl-1 pr-5 py-3 text-right text-xs font-bold text-text-sub uppercase tracking-wider w-[110px]">Qty</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody" class="divide-y divide-slate-100">
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                    
                    <!-- Empty State -->
                    <div id="no-results" class="hidden py-16 text-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-search text-slate-400 text-xl"></i>
                        </div>
                        <p class="text-text-main font-semibold">No items found</p>
                        <p class="text-text-sub text-sm">Try changing the category or search term</p>
                    </div>
                </div>
            </section>

            <!-- ==================== BILL TAB ==================== -->
            <section id="bill-tab" class="tab-content hidden animate-fade-in" role="tabpanel" aria-labelledby="tab-bill">
                
                <!-- Customer Info Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 mb-5">
                    <h3 class="text-sm font-bold text-text-sub uppercase tracking-wider mb-4 flex items-center">
                        <i class="fas fa-user-circle text-brand-primary mr-2 text-lg"></i> Customer Info
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-text-main mb-1.5">Shop Name <span class="text-accent-red">*</span></label>
                            <input type="text" id="shopName" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-base focus:border-brand-primary focus:ring-1 focus:ring-brand-primary outline-none transition" placeholder="e.g. Sri Lakshmi Annapurna Milk Parlour">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-text-main mb-1.5">Phone Number</label>
                            <input type="tel" id="phoneNumber" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-base focus:border-brand-primary focus:ring-1 focus:ring-brand-primary outline-none transition" placeholder="e.g. 80742XXXXX">
                        </div>
                    </div>
                </div>

                <!-- Order Summary Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-24">
                    <div class="bg-slate-50 px-5 py-3 border-b border-slate-200 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-text-main flex items-center">
                            <i class="fas fa-clipboard-list text-text-sub mr-2"></i> Order Items
                        </h3>
                        <button id="clearBillBtn" class="text-xs font-semibold text-accent-red hover:text-red-700 transition" aria-label="Clear all items">
                            Clear All
                        </button>
                    </div>

                    <div id="billItems" class="divide-y divide-slate-100 min-h-[100px]">
                        <!-- JS Injected -->
                    </div>
                    
                    <!-- Empty Cart State -->
                    <div id="bill-empty-state" class="hidden py-12 text-center">
                        <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-basket-shopping text-brand-primary text-2xl"></i>
                        </div>
                        <p class="text-text-main font-medium">Your cart is empty</p>
                        <button id="billEmptyAddItem" class="mt-3 text-sm text-brand-primary font-bold hover:underline">
                            Go to Products
                        </button>
                    </div>
                </div>
            </section>

        </main>

        <!-- 3. STICKY FOOTER (BILL TAB ONLY) -->
        <!-- FIXED: Moved padding from outer container to inner container for perfect alignment -->
        <div id="bill-footer" class="fixed bottom-0 left-0 right-0 w-full bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40 hidden animate-slide-up">
            <div class="max-w-7xl mx-auto px-4 md:px-6 py-4">
                <div class="flex justify-between items-end mb-3">
                    <div>
                        <p class="text-xs text-text-sub font-medium mb-0.5">Net Payable</p>
                        <p id="footer-total" class="text-2xl font-black text-brand-primary leading-none">₹0</p>
                    </div>
                    <div class="text-right">
                         <p class="text-[10px] text-text-sub uppercase font-bold tracking-wider">Summary</p>
                         <p class="text-xs font-semibold text-text-main">
                             <span id="footer-cases">0</span> Cs • <span id="footer-liters">0</span> L
                         </p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <button id="saveDbBtn" class="col-span-1 bg-slate-100 hover:bg-slate-200 text-text-main font-bold py-3 rounded-xl text-sm transition flex items-center justify-center" aria-label="Save to database">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> Save
                    </button>
                    <button id="shareWhatsappBtn" class="col-span-1 bg-accent-green hover:bg-emerald-600 text-white font-bold py-3 rounded-xl text-sm transition flex items-center justify-center" aria-label="Share via WhatsApp">
                        <i class="fab fa-whatsapp text-lg mr-2"></i> Share
                    </button>
                    <button id="generatePdfBtn" class="col-span-1 bg-brand-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-sm transition flex items-center justify-center" aria-label="Download PDF">
                        <i class="fas fa-file-invoice mr-2"></i> PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- TOAST NOTIFICATION -->
        <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] bg-slate-800 text-white px-5 py-3 rounded-full shadow-2xl flex items-center space-x-3 transform -translate-y-20 opacity-0 transition-all duration-500 pointer-events-none w-max max-w-[90%]" role="alert">
            <i id="toast-icon" class="fas fa-check-circle text-accent-green flex-shrink-0"></i>
            <span id="toast-msg" class="font-medium text-sm truncate">Notification</span>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // WARNING: Client-side exposed URL. 
            // Ensure backend (Google Apps Script) validates all incoming data.
            // Do not use for highly sensitive data without a backend proxy.
            const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwpxb9FgVK2xQU6c6IZJP3Y6Hoe15w-jk8PhoUsAHDOZyma-HR7PEnxCrSq2mq8NjxO/exec";

            // STATE
            let cartItems = []; // This array is the Source of Truth
            let currentCategory = 'ALL';
            
            // DATA (Kept as provided)
            const productData = [
                { skuCode: "40311", skuName: "ICE CREAM PULPY MANGO BAR - 60 ML", category: "60ML", size: 60, piecesPerCase: 14, mrpPerPiece: 25, landingPrice: 280 },
                { skuCode: "40315", skuName: "ICE CREAM CHOCO SUNDAE CUP - 75 ml", category: "CUP -75 ML", size: 75, piecesPerCase: 12, mrpPerPiece: 25, landingPrice: 240 },
                { skuCode: "40286", skuName: "ICE CREAM FREEDOM SUNDAE CUP -75 ML", category: "CUP -75 ML", size: 75, piecesPerCase: 12, mrpPerPiece: 25, landingPrice: 240 },
                { skuCode: "40380", skuName: "ICE CREAM BUTTER SCOTCH SUNDAE CUP 75 ML", category: "CUP -75 ML", size: 75, piecesPerCase: 12, mrpPerPiece: 25, landingPrice: 240 },
                { skuCode: "40281", skuName: "ICE CREAM GOLDEN VANILLA TUB-125ML", category: "TUB-125ML", size: 125, piecesPerCase: 6, mrpPerPiece: 40, landingPrice: 192 },
                { skuCode: "40282", skuName: "ICE CREAM BUTTERSCOTCH TUB-125ML", category: "TUB-125ML", size: 125, piecesPerCase: 6, mrpPerPiece: 40, landingPrice: 187.2 },
                { skuCode: "40283", skuName: "ICE CREAM BLACK CURRANT TUB-125ML", category: "TUB-125ML", size: 125, piecesPerCase: 6, mrpPerPiece: 40, landingPrice: 192 },
                { skuCode: "40284", skuName: "ICE CREAM BELGIUM CHOCOLATE TUB-125ML", category: "TUB-125ML", size: 125, piecesPerCase: 6, mrpPerPiece: 50, landingPrice: 240 },
                { skuCode: "40285", skuName: "ICE CREAM ORANGE DELIGHT TUB-125ML", category: "TUB-125ML", size: 125, piecesPerCase: 6, mrpPerPiece: 40, landingPrice: 192 },
                { skuCode: "40310", skuName: "ICE CREAM BUTTERSCOTCH CHOCO BAR - 35 ML", category: "35Ml Bar", size: 35, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 256 },
                { skuCode: "40369", skuName: "ICE CREAM BLACK CURRANT CHOCO BAR - 35 ML", category: "35Ml Bar", size: 35, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 249.6 },
                { skuCode: "40379", skuName: "ICE CREAM DOUBLE CHOCOBAR 35 ML", category: "35Ml Bar", size: 35, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 256 },
                { skuCode: "40007", skuName: "Sr. Choco Bar - 60 Ml", category: "60 ml Bar", size: 60, piecesPerCase: 14, mrpPerPiece: 20, landingPrice: 224 },
                { skuCode: "40042", skuName: "Malai Kulfi Cone - 50 Ml", category: "50 Ml Cone", size: 50, piecesPerCase: 8, mrpPerPiece: 35, landingPrice: 224 },
                { skuCode: "40044", skuName: "KESAR BADAM KULFI BAR - 60 ML", category: "60 ml Bar", size: 60, piecesPerCase: 14, mrpPerPiece: 35, landingPrice: 392 },
                { skuCode: "40045", skuName: "NUTTY BAR-60ML", category: "60 ml Bar", size: 60, piecesPerCase: 14, mrpPerPiece: 35, landingPrice: 392 },
                { skuCode: "40279", skuName: "ICE CREAM ORANGE DELIGHT TUB - 250 ML", category: "250Ml Tub", size: 250, piecesPerCase: 1, mrpPerPiece: 80, landingPrice: 64 },
                { skuCode: "40272", skuName: "ICE CREAM PREMIUM BUTTERSCOTCH TUB -250ML", category: "250Ml Tub", size: 250, piecesPerCase: 1, mrpPerPiece: 80, landingPrice: 64 },
                { skuCode: "40271", skuName: "ICE CREAM BELGIUM CHOCOLATE TUB - 250 ML", category: "250Ml Tub", size: 250, piecesPerCase: 1, mrpPerPiece: 90, landingPrice: 72 },
                { skuCode: "40273", skuName: "ICE CREAM GOLDEN VANILLA TUB-250ML", category: "250Ml Tub", size: 250, piecesPerCase: 1, mrpPerPiece: 70, landingPrice: 56 },
                { skuCode: "40047", skuName: "Mutka Kulfi - 100ML", category: "Matka", size: 100, piecesPerCase: 6, mrpPerPiece: 60, landingPrice: 288 },
                { skuCode: "40124", skuName: "SWINGER MAGIC CUP - 125 ML", category: "Cups", size: 125, piecesPerCase: 8, mrpPerPiece: 50, landingPrice: 320 },
                { skuCode: "40167", skuName: "BLACK CURRANT RIPPLE CUP - 125 ML", category: "Ripple", size: 125, piecesPerCase: 6, mrpPerPiece: 40, landingPrice: 192 },
                { skuCode: "40172", skuName: "CARAMEL RIPPLE CUP - 125 ML", category: "Ripple", size: 125, piecesPerCase: 6, mrpPerPiece: 50, landingPrice: 240 },
                { skuCode: "40173", skuName: "CHOCOLATE RIPPLE CUP - 125 ML", category: "Ripple", size: 125, piecesPerCase: 6, mrpPerPiece: 50, landingPrice: 240 },
                { skuCode: "40180", skuName: "ICE CREAM CHOCO CARAMEL BAR - 70 ML", category: "70 Ml Bar", size: 70, piecesPerCase: 7, mrpPerPiece: 50, landingPrice: 280 },
                { skuCode: "40219", skuName: "ICE CREAM BELGIUM CHOCOLATE BAR - 40ml", category: "BAR - 40ml", size: 40, piecesPerCase: 14, mrpPerPiece: 30, landingPrice: 336 },
                { skuCode: "40220", skuName: "ICE CREAM CHOCO CARAMEL BAR - 40 ml", category: "BAR - 40ml", size: 40, piecesPerCase: 14, mrpPerPiece: 30, landingPrice: 336 },
                { skuCode: "40116", skuName: "PREMIUM VANILLA TUBS - 500 ML", category: "500Ml Tub", size: 500, piecesPerCase: 1, mrpPerPiece: 140, landingPrice: 112 },
                { skuCode: "40117", skuName: "PREMIUM BUTTER SCOTCH TUBS - 500 ML", category: "500Ml Tub", size: 500, piecesPerCase: 1, mrpPerPiece: 160, landingPrice: 128 },
                { skuCode: "40118", skuName: "PREMIUM ANJEER BADAM TUBS - 500 ML", category: "500Ml Tub", size: 500, piecesPerCase: 1, mrpPerPiece: 170, landingPrice: 136 },
                { skuCode: "40120", skuName: "MALAI KULFI TUBS - 500 ML", category: "500Ml Tub", size: 500, piecesPerCase: 1, mrpPerPiece: 180, landingPrice: 144 },
                { skuCode: "40121", skuName: "BELGIUM CHOCOLATE TUBS - 500 ML", category: "500Ml Tub", size: 500, piecesPerCase: 1, mrpPerPiece: 170, landingPrice: 136 },
                { skuCode: "40201", skuName: "ICE CREAM PREMIUM ROYAL KESAR TUBS-500ml", category: "500Ml Tub", size: 500, piecesPerCase: 1, mrpPerPiece: 170, landingPrice: 136 },
                { skuCode: "40146", skuName: "ICE CREAM PREMIUM BLACK CURRANT TUB - 500 ML", category: "500Ml Tub", size: 500, piecesPerCase: 1, mrpPerPiece: 160, landingPrice: 128 },
                { skuCode: "40209", skuName: "ICE CREAM BUTTERSCOTCH CARTON MF-700 ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 280, landingPrice: 224 },
                { skuCode: "40207", skuName: "ICE CREAM STRAWBERRY CARTON MF-700 ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 240, landingPrice: 192 },
                { skuCode: "40206", skuName: "ICE CREAM VANILLA CARTON MF-700 ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 240, landingPrice: 192 },
                { skuCode: "40212", skuName: "Anjeer Carton - 700 Ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 340, landingPrice: 272 },
                { skuCode: "40205", skuName: "ICE CREAM ROYAL KESAR CARTON MF - 700 ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 350, landingPrice: 280 },
                { skuCode: "40208", skuName: "ICE CREAM BLACK CURRANT CARTON MF-700 ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 300, landingPrice: 240 },
                { skuCode: "40210", skuName: "ICE CREAM CHOCO CHIPS CARTON MF-700 ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 300, landingPrice: 240 },
                { skuCode: "40123", skuName: "CARAMEL NUTS CARTON - 700 ML", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 340, landingPrice: 272 },
                { skuCode: "40204", skuName: "ICE CREAM FRUIT NUT CARTON MF - 700 ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 310, landingPrice: 248 },
                { skuCode: "40203", skuName: "ICE CREAM ALPHONSO MANGO CARTON MF-700ml", category: "Paper Pack", size: 1400, piecesPerCase: 1, mrpPerPiece: 260, landingPrice: 208 },
                { skuCode: "40231", skuName: "Butter Scotch Carton - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 580, landingPrice: 475.6 },
                { skuCode: "40232", skuName: "STRAWBERRY CARTON MF - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 415, landingPrice: 340.3 },
                { skuCode: "40233", skuName: "Vanilla Carton - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 440, landingPrice: 360.8 },
                { skuCode: "40235", skuName: "Anjeer Carton - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 935, landingPrice: 766.7 },
                { skuCode: "40228", skuName: "Black Currant Carton - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 735, landingPrice: 602.7 },
                { skuCode: "40238", skuName: "Chocolate Carton - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 595, landingPrice: 487.9 },
                { skuCode: "40312", skuName: "ICE CREAM PISTA CARTON MF - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 435, landingPrice: 356.7 },
                { skuCode: "40313", skuName: "ICE CREAM ROYAL KESAR CARTON MF - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 935, landingPrice: 766.7 },
                { skuCode: "40314", skuName: "ICE CREAM ALPHONSOCONEMANGO MF - 4 L", category: "Party Pack", size: 4000, piecesPerCase: 1, mrpPerPiece: 610, landingPrice: 500.2 },
                { skuCode: "40225", skuName: "Butter Scotch Cup - 40 Ml", category: "Small Cups", size: 40, piecesPerCase: 24, mrpPerPiece: 10, landingPrice: 196.8 },
                { skuCode: "40224", skuName: "Chocolate Cup - 40 Ml", category: "Small Cups", size: 40, piecesPerCase: 24, mrpPerPiece: 10, landingPrice: 196.8 },
                { skuCode: "40221", skuName: "Strawberry Cup MF - 40 Ml", category: "Small Cups", size: 40, piecesPerCase: 24, mrpPerPiece: 10, landingPrice: 196.8 },
                { skuCode: "40223", skuName: "Vanilla Cup MF - 40 Ml", category: "Small Cups", size: 40, piecesPerCase: 24, mrpPerPiece: 10, landingPrice: 196.8 },
                { skuCode: "40254", skuName: "BUTTER SCOTCH CUP MF - 75 ml", category: "Large Cups", size: 75, piecesPerCase: 18, mrpPerPiece: 20, landingPrice: 288 },
                { skuCode: "40255", skuName: "ICE CREAM CHOCOLATE CUP MF - 75 ml", category: "Large Cups", size: 75, piecesPerCase: 18, mrpPerPiece: 20, landingPrice: 280.8 },
                { skuCode: "40256", skuName: "ICE CREAM VANILLA CUP MF - 75 ml", category: "Large Cups", size: 75, piecesPerCase: 18, mrpPerPiece: 20, landingPrice: 288 },
                { skuCode: "40215", skuName: "ICE CREAM COTTON CANDY B/SCOTCH BAR-60ml", category: "Small Cones", size: 60, piecesPerCase: 14, mrpPerPiece: 20, landingPrice: 218.4 },
                { skuCode: "40216", skuName: "ICE CREAM RASPBERRY & LITCHI BAR - 60ml", category: "Small Cones", size: 60, piecesPerCase: 14, mrpPerPiece: 20, landingPrice: 218.4 },
                { skuCode: "40161", skuName: "Round & Round - 80Ml", category: "Extuder Bar", size: 80, piecesPerCase: 14, mrpPerPiece: 25, landingPrice: 280 },
                { skuCode: "40162", skuName: "Crazy wheel - 60 Ml", category: "Extuder Bar", size: 60, piecesPerCase: 14, mrpPerPiece: 20, landingPrice: 224 },
                { skuCode: "40163", skuName: "Magic Twist - 80 Ml", category: "Extuder Bar", size: 80, piecesPerCase: 14, mrpPerPiece: 25, landingPrice: 280 },
                { skuCode: "40133", skuName: "ICE CREAM BUTTER SCOTCH CONE - 50 ML", category: "Small Cones", size: 50, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 256 },
                { skuCode: "40134", skuName: "Chocolate Cone - 50 Ml", category: "Small Cones", size: 50, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 256 },
                { skuCode: "40226", skuName: "Strawberry Cone - 50 Ml", category: "Small Cones", size: 50, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 256 },
                { skuCode: "40135", skuName: "Vanilla Cone - 50 Ml", category: "Small Cones", size: 50, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 249.6 },
                { skuCode: "40218", skuName: "ICE CREAM KESAR BADAM CONE - 50 m", category: "Small Cones", size: 50, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 256 },
                { skuCode: "40217", skuName: "Black Current Cone - 50 ml", category: "Small Cones", size: 50, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 256 },
                { skuCode: "40309", skuName: "ICE CREAM PISTA CONE - 50 ml", category: "Small Cones", size: 50, piecesPerCase: 16, mrpPerPiece: 20, landingPrice: 256 },
                { skuCode: "40329", skuName: "ICE CREAM BELGIUM CHOCOLATE CONE - 110 m", category: "Big Cones", size: 110, piecesPerCase: 16, mrpPerPiece: 50, landingPrice: 640 },
                { skuCode: "40059", skuName: "Black Currant Cone - 110 Ml", category: "Big Cones", size: 110, piecesPerCase: 16, mrpPerPiece: 40, landingPrice: 512 },
                { skuCode: "40213", skuName: "ICE CREAM KESAR BADAM CONE - 110 m", category: "Big Cones", size: 110, piecesPerCase: 16, mrpPerPiece: 40, landingPrice: 499.2 },
                { skuCode: "40017", skuName: "Butter Scotch Cone - 110 Ml", category: "Big Cones", size: 110, piecesPerCase: 16, mrpPerPiece: 40, landingPrice: 512 },
                { skuCode: "40018", skuName: "Chocolate Cone - 110 Ml", category: "Big Cones", size: 110, piecesPerCase: 16, mrpPerPiece: 40, landingPrice: 512 },
                { skuCode: "40019", skuName: "Strawberry Cone - 110 Ml", category: "Big Cones", size: 110, piecesPerCase: 16, mrpPerPiece: 40, landingPrice: 512 },
                { skuCode: "40020", skuName: "Vanilla Cone - 110 Ml", category: "Big Cones", size: 110, piecesPerCase: 16, mrpPerPiece: 40, landingPrice: 512 },
                { skuCode: "40258", skuName: "Jr. Choco Bar - 35 Ml", category: "35Ml Bar", size: 35, piecesPerCase: 16, mrpPerPiece: 10, landingPrice: 131.2 },
                { skuCode: "40150", skuName: "JUICE BAR GRAPE - 60 ml", category: "60 ml Bar", size: 60, piecesPerCase: 18, mrpPerPiece: 10, landingPrice: 147.6 },
                { skuCode: "40185", skuName: "Mango Juicy bar - 60 Ml", category: "60 ml Bar", size: 60, piecesPerCase: 18, mrpPerPiece: 10, landingPrice: 147.6 },
                { skuCode: "40151", skuName: "JUICE BAR ORANGE - 60 ml", category: "60 ml Bar", size: 60, piecesPerCase: 18, mrpPerPiece: 10, landingPrice: 147.6 }
            ];

            // DOM ELEMENTS
            const D = {
                tabs: document.querySelectorAll('.tab-btn'),
                tabContents: document.querySelectorAll('.tab-content'),
                hValue: document.getElementById('header-total-value'),
                hCases: document.getElementById('header-total-cases'),
                hLiters: document.getElementById('header-total-liters'),
                billBadge: document.getElementById('bill-badge'),
                searchInput: document.getElementById('searchInput'),
                clearSearchBtn: document.getElementById('clearSearchBtn'),
                categoryChips: document.getElementById('category-chips'),
                tableBody: document.getElementById('productTableBody'),
                noResults: document.getElementById('no-results'),
                billItems: document.getElementById('billItems'),
                billEmpty: document.getElementById('bill-empty-state'),
                billEmptyBtn: document.getElementById('billEmptyAddItem'),
                shopName: document.getElementById('shopName'),
                phone: document.getElementById('phoneNumber'),
                // Footer elements
                billFooter: document.getElementById('bill-footer'),
                footerTotal: document.getElementById('footer-total'),
                footerCases: document.getElementById('footer-cases'),
                footerLiters: document.getElementById('footer-liters'),
                
                clearBtn: document.getElementById('clearBillBtn'),
                pdfBtn: document.getElementById('generatePdfBtn'),
                waBtn: document.getElementById('shareWhatsappBtn'),
                headerShare: document.getElementById('headerShareBtn'),
                saveDbBtn: document.getElementById('saveDbBtn'),
                toast: document.getElementById('toast'),
                toastMsg: document.getElementById('toast-msg'),
                toastIcon: document.getElementById('toast-icon'),
            };

            // HELPERS
            const getLandingPrice = (item) => item.landingPrice;
            function sanitizeFilename(name) { return name.replace(/[^a-z0-9_-\s]/gi, '').replace(/\s+/g, '_'); }

            // FIX: Security - Input Sanitization
            function sanitizeInput(input) {
                return input ? input.replace(/[<>]/g, '').trim() : '';
            }

            // FIX: Security - Phone Validation
            function validatePhone(phone) {
                return /^[6-9]\d{9}$/.test(phone.replace(/\D/g, ''));
            }

            // CORE: INIT TABLE
            function initProductTable() {
                const fragment = document.createDocumentFragment();
                productData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'item-row border-b border-slate-50 hover:bg-blue-50/40 transition-colors';
                    row.dataset.search = (item.skuName + item.skuCode).toLowerCase();
                    row.dataset.category = item.category;
                    row.dataset.sku = item.skuCode;
                    row.dataset.price = item.landingPrice;

                    row.innerHTML = `
                        <td class="px-4 py-3.5 align-top">
                            <div class="font-bold text-sm text-text-main leading-snug mb-0.5 line-clamp-2">${item.skuName}</div>
                            <div class="text-xs text-text-sub font-medium truncate">
                                ${item.skuCode} • ${item.category} • ${item.piecesPerCase}pcs
                            </div>
                        </td>
                        <td class="px-1 py-3.5 text-center align-top">
                            <span class="bg-slate-100 text-text-main text-xs font-bold px-2 py-1 rounded-md whitespace-nowrap">₹${item.mrpPerPiece}</span>
                        </td>
                        <td class="pl-1 pr-5 py-3.5 align-top">
                            <div class="flex flex-col items-end space-y-1">
                                <div class="flex items-center bg-white border border-slate-200 rounded-lg p-0.5 shadow-sm">
                                    <button class="qty-btn-minus w-8 h-8 flex items-center justify-center text-accent-red hover:bg-red-50 rounded-md transition" data-sku="${item.skuCode}" aria-label="Decrease quantity">
                                        <i class="fas fa-minus text-xs"></i>
                                    </button>
                                    <input type="number" inputmode="numeric" min="0" class="qty-input w-10 text-center font-bold text-text-main text-base bg-transparent border-none focus:ring-0 p-0" value="0" data-sku="${item.skuCode}" aria-label="Quantity for ${item.skuName}">
                                    <button class="qty-btn-plus w-8 h-8 flex items-center justify-center text-brand-primary hover:bg-blue-50 rounded-md transition" data-sku="${item.skuCode}" aria-label="Increase quantity">
                                        <i class="fas fa-plus text-xs"></i>
                                    </button>
                                </div>
                                <div class="text-xs font-bold text-transparent row-total transition-colors">₹0</div>
                            </div>
                        </td>
                    `;
                    fragment.appendChild(row);
                });
                D.tableBody.appendChild(fragment);
            }

            // CORE: RENDER CHIPS
            function renderCategoryChips() {
                const categories = ['ALL', ...new Set(productData.map(p => p.category))];
                D.categoryChips.innerHTML = categories.map(cat => `
                    <button class="category-chip snap-start whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition-all shadow-sm border
                    ${cat === currentCategory ? 'bg-brand-primary text-white border-brand-primary' : 'bg-white text-text-sub border-slate-200 hover:border-brand-primary/30'}" 
                    data-category="${cat}" aria-label="Filter by ${cat === 'ALL' ? 'All Categories' : cat}">
                        ${cat === 'ALL' ? 'All' : cat}
                    </button>
                `).join('');
            }

            function updateChipStyles() {
                Array.from(D.categoryChips.children).forEach(chip => {
                    const isActive = chip.dataset.category === currentCategory;
                    if (isActive) {
                        chip.className = 'category-chip snap-start whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition-all shadow-sm border bg-brand-primary text-white border-brand-primary';
                    } else {
                        chip.className = 'category-chip snap-start whitespace-nowrap px-4 py-2 rounded-full text-xs font-bold transition-all shadow-sm border bg-white text-text-sub border-slate-200 hover:border-brand-primary/30';
                    }
                });
            }

            // CORE: FILTERING
            function filterTable(filterText = '') {
                const q = filterText.toLowerCase();
                let visibleCount = 0;
                const rows = D.tableBody.children;
                
                // Toggle clear button
                D.clearSearchBtn.classList.toggle('hidden', !q);

                for (let row of rows) {
                    const matchSearch = !q || row.dataset.search.includes(q);
                    const matchCat = currentCategory === 'ALL' || row.dataset.category === currentCategory;
                    if (matchSearch && matchCat) {
                        row.classList.remove('d-none');
                        visibleCount++;
                    } else {
                        row.classList.add('d-none');
                    }
                }
                D.noResults.classList.toggle('hidden', visibleCount > 0);
            }

            // FIX: Performance - Search Debounce
            let searchTimeout;
            D.searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => filterTable(e.target.value), 300);
            });

            // FIX: State Management - Safe Update
            function updateCart(sku, newQuantity) {
                // Ensure quantity is a valid non-negative integer
                newQuantity = Math.max(0, parseInt(newQuantity) || 0);
                
                // Validate SKU exists in product data
                const product = productData.find(p => p.skuCode === sku);
                if (!product) {
                    console.error("Invalid SKU detected:", sku);
                    return;
                }

                const existingIndex = cartItems.findIndex(i => i.skuCode === sku);

                if (newQuantity > 0) {
                    if (existingIndex > -1) {
                        cartItems[existingIndex].cases = newQuantity;
                    } else {
                        cartItems.push({ ...product, cases: newQuantity });
                        if (newQuantity === 1) showToast(`Added: ${product.skuName.substring(0, 20)}...`);
                    }
                } else {
                    if (existingIndex > -1) cartItems.splice(existingIndex, 1);
                }
                updateTotals();
            }

            function refreshProductInputs() {
                const qtyMap = {};
                cartItems.forEach(item => qtyMap[item.skuCode] = item.cases);
                const rows = D.tableBody.children;
                
                // Loop through all rows to ensure everything is synced
                for (let row of rows) {
                    const sku = row.dataset.sku;
                    const qty = qtyMap[sku] || 0;
                    const input = row.querySelector('.qty-input');
                    const totalEl = row.querySelector('.row-total');
                    
                    if (input.value != qty) {
                         input.value = qty;
                    }
                    
                    const price = parseFloat(row.dataset.price); 
                    const totalVal = qty * price;
                    totalEl.textContent = `₹${totalVal.toLocaleString('en-IN', {maximumFractionDigits: 2})}`; // Fixed decimal formatting
                    
                    // Toggle visibility classes
                    if (qty > 0) {
                        totalEl.classList.remove('text-transparent');
                        totalEl.classList.add('text-brand-primary');
                    } else {
                        totalEl.classList.add('text-transparent');
                        totalEl.classList.remove('text-brand-primary');
                    }
                }
            }

            function updateTotals() {
                const totals = cartItems.reduce((acc, item) => {
                    acc.cases += item.cases;
                    acc.value += item.cases * getLandingPrice(item);
                    acc.liters += (item.cases * item.piecesPerCase * item.size) / 1000;
                    return acc;
                }, { cases: 0, value: 0, liters: 0 });

                // Update Header
                D.hValue.textContent = `₹${totals.value.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`; // Consistent decimals
                D.hCases.textContent = totals.cases;
                D.hLiters.textContent = totals.liters.toFixed(1);
                
                // Update Badge
                D.billBadge.textContent = cartItems.length;
                D.billBadge.classList.toggle('hidden', cartItems.length === 0);

                // Update Footer & Bill Summary
                const fmtTotal = `₹${totals.value.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}`; // Flexible formatting
                D.footerTotal.textContent = fmtTotal;
                D.footerCases.textContent = totals.cases;
                D.footerLiters.textContent = totals.liters.toFixed(1);
            }

            // CORE: BILL VIEW
            function renderBillView() {
                // Sort by name for easier reading
                cartItems.sort((a, b) => a.skuName.localeCompare(b.skuName));

                if (cartItems.length === 0) {
                    D.billItems.innerHTML = '';
                    D.billEmpty.classList.remove('hidden');
                    D.billFooter.classList.add('hidden'); 
                } else {
                    D.billEmpty.classList.add('hidden');
                    D.billFooter.classList.remove('hidden'); 

                    D.billItems.innerHTML = cartItems.map(item => {
                        const landingPrice = getLandingPrice(item);
                        return `
                            <div class="p-4 flex items-center animate-slide-up group">
                                <div class="flex-1 pr-3">
                                    <h4 class="text-sm font-bold text-text-main leading-tight mb-1">${item.skuName}</h4>
                                    <div class="flex items-center text-xs text-text-sub">
                                        <span class="bg-slate-100 px-1.5 py-0.5 rounded mr-2 text-text-main font-semibold whitespace-nowrap">₹${landingPrice}/case</span>
                                        <span class="truncate">${item.skuCode}</span>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end">
                                    <div class="flex items-center space-x-3 mb-1">
                                        <div class="flex items-center border-b-2 border-slate-100 focus-within:border-brand-primary transition-colors">
                                            <input type="number" inputmode="numeric" min="0" class="bill-qty-input w-10 text-center font-bold text-lg bg-transparent border-none focus:ring-0 p-0" 
                                                value="${item.cases}" data-sku="${item.skuCode}" aria-label="Quantity for ${item.skuName}">
                                            <span class="text-[10px] font-bold text-text-sub uppercase ml-1">Cs</span>
                                        </div>
                                    </div>
                                    <div class="text-sm font-bold text-brand-primary">
                                        ₹${(item.cases * landingPrice).toLocaleString('en-IN', {maximumFractionDigits: 2})}
                                    </div>
                                </div>
                                <button class="bill-remove-btn ml-4 w-8 h-8 flex items-center justify-center text-slate-300 hover:text-accent-red hover:bg-red-50 rounded-full transition" data-sku="${item.skuCode}" aria-label="Remove ${item.skuName}">
                                    <i class="fas fa-trash-alt text-sm"></i>
                                </button>
                            </div>
                        `;
                    }).join('');
                }
            }

            // NAVIGATION
            window.switchTab = (targetId) => {
                D.tabs.forEach(t => {
                    if(t.dataset.target === targetId) {
                        t.classList.add('tab-active', 'bg-blue-50', 'text-brand-primary');
                        t.classList.remove('tab-inactive', 'text-text-sub');
                        t.setAttribute('aria-selected', 'true');
                    } else {
                        t.classList.remove('tab-active', 'bg-blue-50', 'text-brand-primary');
                        t.classList.add('tab-inactive', 'text-text-sub');
                        t.setAttribute('aria-selected', 'false');
                    }
                });
                
                D.tabContents.forEach(tc => {
                   if (tc.id === targetId) {
                       tc.classList.remove('hidden');
                       if (targetId === 'bill-tab') {
                           renderBillView();
                       } else {
                           // UPDATED: Explicitly hide bill footer when leaving bill tab
                           D.billFooter.classList.add('hidden');
                       }
                       if (targetId === 'items-tab') refreshProductInputs();
                   } else {
                       tc.classList.add('hidden');
                   }
                });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // EVENT LISTENERS
            D.categoryChips.addEventListener('click', (e) => {
                const btn = e.target.closest('.category-chip');
                if (!btn) return;
                currentCategory = btn.dataset.category;
                updateChipStyles();
                filterTable(D.searchInput.value);
            });

            D.clearSearchBtn.addEventListener('click', () => {
                D.searchInput.value = '';
                filterTable('');
            });

            // Optimized Event Delegation for Inputs
            const handleInputLogic = (target, isBillView = false) => {
                const sku = target.dataset.sku;
                let val;
                
                if (target.value === '') {
                    val = 0; // Treat empty string as 0 temporarily for display logic
                } else {
                    val = parseInt(target.value);
                }

                if (isNaN(val) || val < 0) val = 0;
                
                // Use new safe updateCart instead of syncCart
                updateCart(sku, val);
                
                if (isBillView) {
                    const row = target.closest('.p-4');
                    const product = productData.find(p => p.skuCode === sku);
                    const priceDisplay = row.querySelector('.text-brand-primary');
                    if(priceDisplay) priceDisplay.textContent = `₹${(val * getLandingPrice(product)).toLocaleString('en-IN', {maximumFractionDigits: 2})}`;
                    
                    if (val === 0) {
                         // Don't remove immediately while typing, only on blur (handled by focusout)
                         target.classList.add('text-slate-400');
                    } else {
                        target.classList.remove('text-slate-400');
                    }
                } else {
                    // Items Table update logic handled by updateCart -> we just update local display
                    const row = target.closest('tr');
                    const price = parseFloat(row.dataset.price);
                    const totalEl = row.querySelector('.row-total');
                    totalEl.textContent = `₹${(val * price).toLocaleString('en-IN', {maximumFractionDigits: 2})}`;
                    
                    if (val > 0) {
                        totalEl.classList.remove('text-transparent');
                        totalEl.classList.add('text-brand-primary');
                    } else {
                        totalEl.classList.add('text-transparent');
                        totalEl.classList.remove('text-brand-primary');
                    }
                }
            };

            // Main Table Listeners
            D.tableBody.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const input = btn.parentElement.querySelector('.qty-input');
                let current = parseInt(input.value) || 0;
                if (btn.classList.contains('qty-btn-plus')) input.value = current + 1;
                else if (btn.classList.contains('qty-btn-minus') && current > 0) input.value = current - 1;
                else return;
                handleInputLogic(input);
            });

            D.tableBody.addEventListener('input', (e) => {
                if (e.target.classList.contains('qty-input')) handleInputLogic(e.target);
            });
            
            D.tableBody.addEventListener('focusout', (e) => {
                if (e.target.classList.contains('qty-input')) {
                    if(e.target.value === '' || parseInt(e.target.value) === 0) {
                        e.target.value = 0;
                        handleInputLogic(e.target);
                    }
                }
            });

            // Bill View Listeners
            D.billItems.addEventListener('input', (e) => {
                 if (e.target.classList.contains('bill-qty-input')) handleInputLogic(e.target, true);
            });
            
            D.billItems.addEventListener('focusout', (e) => {
                if (e.target.classList.contains('bill-qty-input')) {
                    if (e.target.value === '' || parseInt(e.target.value) === 0) {
                        e.target.value = 0;
                        updateCart(e.target.dataset.sku, 0); // Ensure state is 0
                        renderBillView(); // Re-render to remove the item
                    }
                }
            });

            D.billItems.addEventListener('click', (e) => {
                const btn = e.target.closest('.bill-remove-btn');
                if (btn) {
                    const row = btn.closest('.p-4');
                    row.classList.add('opacity-0', 'scale-95', 'transition-all', 'duration-300');
                    setTimeout(() => {
                          updateCart(btn.dataset.sku, 0);
                          renderBillView();
                     }, 300);
                }
            });

            // Tabs
            D.tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.target)));
            D.billEmptyBtn.addEventListener('click', () => switchTab('items-tab'));
            D.clearBtn.addEventListener('click', () => {
                if(cartItems.length > 0 && confirm('Clear entire order?')) {
                      cartItems = [];
                      D.shopName.value = '';
                      D.phone.value = '';
                      updateTotals();
                      renderBillView();
                      refreshProductInputs();
                }
            });

            // FIX: Improved Fetch with Retry & Error Handling
            async function saveToGoogleSheets(data, retries = 3, backoff = 1000) {
                try {
                    // Standard fetch without no-cors to allow error handling
                    // Note: If GAS script doesn't support CORS, you might need to revert to 'no-cors'
                    const response = await fetch(APP_SCRIPT_URL, {
                        method: 'POST',
                        // mode: 'no-cors', // Uncomment if CORS issues persist
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(data)
                    });
                    
                    // Only check .ok if mode is not no-cors
                    if (response.type !== 'opaque' && !response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    
                    return true;
                } catch (error) {
                    if (retries > 0) {
                        console.warn(`Save failed, retrying in ${backoff}ms...`, error);
                        await new Promise(r => setTimeout(r, backoff));
                        return saveToGoogleSheets(data, retries - 1, backoff * 2);
                    }
                    throw error;
                }
            }

            // EXTERNAL ACTIONS (Save/PDF/Share)
            async function executeDbSave(isAutoSave = false) {
                 if (cartItems.length === 0) { if(!isAutoSave) showToast('Empty Cart!', 'error'); return false; }
                 
                 const shopName = sanitizeInput(D.shopName.value);
                 const phone = D.phone.value.trim();

                 if (!shopName) { if(!isAutoSave) { D.shopName.focus(); showToast('Enter Shop Name', 'error'); } return false; }
                 
                 // FIX: Phone Validation
                 if (phone && !validatePhone(phone)) {
                     if(!isAutoSave) { D.phone.focus(); showToast('Invalid Phone Number', 'error'); }
                     return false;
                 }

                 const originalText = D.saveDbBtn.innerHTML;
                 if (!isAutoSave) { D.saveDbBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; D.saveDbBtn.disabled = true; }

                 try {
                    await saveToGoogleSheets({
                        date: new Date().toLocaleDateString('en-IN'),
                        timestamp: new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }),
                        shopName: shopName,
                        phone: phone,
                        totalCases: D.hCases.textContent,
                        totalLiters: D.hLiters.textContent,
                        totalAmount: D.footerTotal.textContent.replace(/[₹,]/g, ''),
                        items: cartItems.map(i => ({ sku: i.skuCode, name: i.skuName, cases: i.cases, price: getLandingPrice(i) }))
                    });
                    
                    showToast(isAutoSave ? 'Auto-saved' : 'Order Saved!');
                    return true;
                 } catch (e) {
                     console.error(e);
                     showToast('Save Failed (Network)', 'error');
                     return false;
                 } finally {
                     if (!isAutoSave) { D.saveDbBtn.innerHTML = originalText; D.saveDbBtn.disabled = false; }
                 }
            }

            D.saveDbBtn.addEventListener('click', () => executeDbSave(false));

            // PDF Generation
            D.pdfBtn?.addEventListener('click', async () => { 
                 const shopName = sanitizeInput(D.shopName.value);
                 if (cartItems.length === 0) return showToast('Cart Empty', 'error');
                 if (!shopName) { D.shopName.focus(); return showToast('Enter Shop Name', 'error'); }
                 
                 // Auto-save before PDF
                 await executeDbSave(true);
                 
                 const { jsPDF } = window.jspdf;
                 const doc = new jsPDF();
                 const dateStr = new Date().toLocaleDateString('en-IN');
                 
                 doc.setFillColor(37, 99, 235); // Brand Blue
                 doc.rect(0, 0, 210, 40, 'F');
                 doc.setTextColor(255, 255, 255);
                 doc.setFontSize(22); doc.setFont('helvetica', 'bold');
                 doc.text('VISWANATH AGENCIES', 14, 20);
                 doc.setFontSize(10); doc.setFont('helvetica', 'normal');
                 doc.text(`Order Date: ${dateStr}`, 196, 20, { align: 'right' });
                 
                 doc.setTextColor(30, 41, 59);
                 doc.setFontSize(12); doc.setFont('helvetica', 'bold');
                 doc.text(`Bill To: ${shopName}`, 14, 55);
                 if(D.phone.value) doc.text(`Phone: ${D.phone.value}`, 14, 62);

                 // Consistent formatting for table rows
                 const rows = cartItems.map(i => [
                     i.skuCode, 
                     i.skuName, 
                     i.cases, 
                     (i.cases*i.piecesPerCase), 
                     `Rs.${getLandingPrice(i)}`, 
                     `Rs.${(i.cases*getLandingPrice(i)).toLocaleString('en-IN', {maximumFractionDigits: 2})}`
                 ]);
                 
                 doc.autoTable({
                     startY: 70,
                     head: [['SKU', 'Item', 'Cases', 'Pcs', 'Rate', 'Total']],
                     body: rows,
                     theme: 'grid',
                     headStyles: { fillColor: [37, 99, 235], fontStyle: 'bold' },
                     columnStyles: { 1: { cellWidth: 'auto' }, 5: { halign: 'right', fontStyle: 'bold' } }
                 });
                 
                 const finalY = doc.lastAutoTable.finalY + 10;
                 doc.setFontSize(14); doc.setTextColor(37, 99, 235);
                 
                 // FIX: Replace '₹' with 'Rs. ' to prevent garbage characters in PDF
                 const pdfTotal = D.footerTotal.textContent.replace('₹', 'Rs. ');
                 doc.text(`Total Payable: ${pdfTotal}`, 196, finalY, { align: 'right' });
                 
                 doc.save(`${sanitizeFilename(shopName)}_${dateStr}.pdf`);
                 showToast('PDF Downloaded');
            });

            // WhatsApp Share
            D.waBtn?.addEventListener('click', () => { 
                if (cartItems.length === 0) return showToast('Cart Empty', 'error');
                const shopName = sanitizeInput(D.shopName.value) || 'Customer';
                const msg = `*ORDER: ${shopName}*\n` +
                            `Cases: ${D.hCases.textContent} | Amount: ${D.footerTotal.textContent}\n\n` +
                            cartItems.map(i => `• ${i.cases}cs ${i.skuName}`).join('\n');
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            });

            // Utilities
            function showToast(msg, type='success') {
                clearTimeout(window.tt);
                D.toastMsg.textContent = msg;
                D.toastIcon.className = type === 'success' ? 'fas fa-check-circle text-accent-green' : 'fas fa-exclamation-circle text-accent-red';
                D.toast.classList.remove('opacity-0', '-translate-y-20');
                window.tt = setTimeout(() => D.toast.classList.add('opacity-0', '-translate-y-20'), 3000);
            }

            // Init
            renderCategoryChips();
            initProductTable();
        });
    </script>
</body>
</html>
